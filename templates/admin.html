{% extends "layout.html" %}

{% block title %}Admin Paneli{% endblock %}

{% block head %}
<style>
    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
    }
    .stat-card h3 {
        color: #666;
        margin-bottom: 10px;
        font-size: 14px;
        text-transform: uppercase;
    }
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #667eea;
    }
    .admin-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    .action-btn {
        padding: 15px;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }
    .action-btn:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
        transform: translateY(-2px);
    }
    .logout-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
    }
    .logout-btn:hover {
        background: #c82333;
    }
    .info-box {
        background: #e7f3ff;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>ğŸ› ï¸ Admin Paneli</h1>
    <a href="/admin/logout" class="logout-btn">Ã‡Ä±kÄ±ÅŸ Yap</a>
</div>

<div class="info-box">
    <p><strong>Merhaba, {{ session.username }}!</strong> HoÅŸ geldiniz. Son giriÅŸ: {{ server_time }}</p>
    <p>Firebase Admin Durumu: <strong>{{ 'âœ… Aktif' if firebase_ready else 'âš ï¸ Pasif' }}</strong></p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <h3>Site Ziyaretleri</h3>
        <div class="stat-value">{{ stats.site_visits }}</div>
    </div>
    <div class="stat-card">
        <h3>Aktif KullanÄ±cÄ±lar</h3>
        <div class="stat-value">{{ stats.active_users }}</div>
    </div>
    <div class="stat-card">
        <h3>Depolama KullanÄ±mÄ±</h3>
        <div class="stat-value">{{ stats.storage_used }}</div>
    </div>
    <div class="stat-card">
        <h3>Ã‡alÄ±ÅŸma SÃ¼resi</h3>
        <div class="stat-value">{{ stats.uptime }}</div>
    </div>
</div>

<div class="admin-actions">
    <div class="action-btn" onclick="testFirebase()">
        <strong>Firebase Test</strong>
        <p>Firestore baÄŸlantÄ±sÄ±nÄ± kontrol et</p>
    </div>
    <div class="action-btn" onclick="clearCache()">
        <strong>Ã–nbelleÄŸi Temizle</strong>
        <p>GeÃ§ici dosyalarÄ± temizle</p>
    </div>
    <div class="action-btn" onclick="checkLogs()">
        <strong>Sistem LoglarÄ±</strong>
        <p>Uygulama loglarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le</p>
    </div>
    <div class="action-btn" onclick="restartService()">
        <strong>Servisi Yeniden BaÅŸlat</strong>
        <p>UygulamayÄ± yeniden baÅŸlat</p>
    </div>
    <div class="action-btn" onclick="exportData()">
        <strong>Veri DÄ±ÅŸa Aktar</strong>
        <p>VeritabanÄ± yedeÄŸi al</p>
    </div>
    <div class="action-btn" onclick="openRenderDashboard()">
        <strong>Render Dashboard</strong>
        <p>Render kontrol paneline git</p>
    </div>
</div>

<div class="demo-section">
    <h2>GerÃ§ek ZamanlÄ± Firebase Verisi</h2>
    <button onclick="subscribeToFirebase()" class="btn btn-primary">Firebase AboneliÄŸi BaÅŸlat</button>
    <div id="realtime-data" class="result" style="margin-top: 20px;"></div>
</div>

<div class="demo-section">
    <h2>Sistem Bilgileri</h2>
    <pre id="system-info">YÃ¼kleniyor...</pre>
    <button onclick="refreshSystemInfo()" class="btn btn-secondary">Yenile</button>
</div>
{% endblock %}

{% block scripts %}
<script>
async function testFirebase() {
    try {
        const response = await fetch('/api/firebase-test');
        const data = await response.json();
        alert(data.message);
    } catch (error) {
        alert('Firebase test hatasÄ±: ' + error.message);
    }
}

function clearCache() {
    if (confirm('TarayÄ±cÄ± Ã¶nbelleÄŸi temizlenecek. Emin misiniz?')) {
        localStorage.clear();
        alert('Ã–nbellek temizlendi!');
    }
}

function checkLogs() {
    window.open('/api/health', '_blank');
}

function restartService() {
    if (confirm('Servis yeniden baÅŸlatÄ±lacak. Emin misiniz?')) {
        alert('Bu iÅŸlem Render dashboard Ã¼zerinden yapÄ±lmalÄ±dÄ±r.');
    }
}

function exportData() {
    alert('Veri dÄ±ÅŸa aktarma iÅŸlemi baÅŸlatÄ±ldÄ±...');
    // Burada Firebase verilerini dÄ±ÅŸa aktarma kodu
}

function openRenderDashboard() {
    window.open('https://dashboard.render.com', '_blank');
}

async function subscribeToFirebase() {
    const container = document.getElementById('realtime-data');
    container.innerHTML = '<div class="loading">Abonelik baÅŸlatÄ±lÄ±yor...</div>';
    
    try {
        const firestore = firebase.firestore();
        const unsubscribe = firestore.collection('health_checks')
            .orderBy('timestamp', 'desc')
            .limit(5)
            .onSnapshot((snapshot) => {
                let html = '<h4>Son Firebase KayÄ±tlarÄ±:</h4>';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                            <strong>${new Date(data.timestamp).toLocaleString()}</strong><br>
                            ${data.service || 'N/A'} - ${data.status || 'N/A'}
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        
        window.firebaseUnsubscribe = unsubscribe;
    } catch (error) {
        container.innerHTML = `<div class="error">Firebase aboneliÄŸi hatasÄ±: ${error.message}</div>`;
    }
}

async function refreshSystemInfo() {
    const pre = document.getElementById('system-info');
    pre.textContent = 'YÃ¼kleniyor...';
    
    try {
        const response = await fetch('/api/health');
        const data = await response.json();
        pre.textContent = JSON.stringify(data, null, 2);
    } catch (error) {
        pre.textContent = 'Hata: ' + error.message;
    }
}

// Sayfa yÃ¼klendiÄŸinde sistem bilgilerini getir
window.onload = refreshSystemInfo;
</script>
{% endblock %}